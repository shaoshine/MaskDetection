# åŸºäºPaddleDetectionçš„å£ç½©æ£€æµ‹

# -[é¡¹ç›®ä¸»é¡µ](https://aistudio.baidu.com/aistudio/projectdetail/3516913) å¦‚æœé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œå¯ä»¥ç‚¹ä¸ªforkå“¦

# ä¸€ã€é¡¹ç›®èƒŒæ™¯
é˜²æ§ç–«æƒ…ï¼Œä¼—å¿—æˆåŸã€‚äººå·¥æ™ºèƒ½æŠ€æœ¯æ­£è¢«åº”ç”¨åˆ°ç–«æƒ…é˜²æ§ä¸­æ¥ã€‚

â€œæ§åˆ¶ä¼ æŸ“æºã€åˆ‡æ–­ä¼ æ’­é€”å¾„å’Œæ’æŸ¥æ˜“æ„Ÿäººç¾¤â€æ˜¯æ‰“èµ¢æŠ—ç–«çš„ä¸‰ç§æ‰‹æ®µã€‚
 
å…¶ä¸­åˆ‡æ–­ä¼ æ’­é€”å¾„ä¸­ï¼Œä½©æˆ´å£ç½©å·²ç»å‡ ä¹æˆä¸ºäº†æœ€é‡è¦çš„ä¸¾æªä¹‹ä¸€ã€‚ä½†æ˜¯åœ¨å®é™…åœºæ™¯ä¸­ï¼Œä»ç„¶æœ‰ä¸é‡è§†ã€ä¸æ³¨æ„ã€ä¾¥å¹¸å¿ƒç†çš„äººå‘˜ä¸æˆ´å£ç½©ï¼Œå°¤å…¶åœ¨å…¬ä¼—åœºåˆï¼Œç»™ä¸ªäººå’Œå…¬ä¼—é€ æˆæå¤§çš„é£é™©éšæ‚£ã€‚

**åœ¨å…¬å…±åœºåˆï¼Œä¾é ä¼ ç»Ÿæ–¹æ³•ä¸­äººä¸ºç›‘ç®¡ï¼Œå·¥ä½œé‡å·¨å¤§è€Œä¸”æä¸ºè€—æ—¶**

å› æ­¤ï¼Œé€šè¿‡è®¡ç®—æœºè§†è§‰çš„æ–¹æ³•ï¼Œæ‰¾åˆ°ä¸€ç§èƒ½å¤Ÿå¿«é€Ÿã€å‡†ç¡®æ£€æµ‹æ˜¯å¦ä½©æˆ´å£ç½©çš„ç®—æ³•ï¼Œå®ç°å¯¹äººç¾¤æ˜¯å¦ä½©æˆ´å£ç½©è¿›è¡Œç›‘æ§ï¼Œå¯¹å…¬å…±å®‰å…¨é˜²æ§ã€å…¬å…±èµ„æºçš„èŠ‚çœç­‰æ–¹é¢å…·æœ‰é‡è¦çš„ä½œç”¨ã€‚

- [åŸºäºæ ‘è“æ´¾4Bä¸Paddle-Liteå®ç°çš„å®æ—¶å£ç½©è¯†åˆ«](https://aistudio.baidu.com/aistudio/projectdetail/315730?shared=1)

- [ç™¾åº¦é£æ¡¨æºæ‰‹åŒ—äº¬åœ°é“è½åœ°AIå£ç½©æ£€æµ‹æ–¹æ¡ˆ](https://mp.weixin.qq.com/s/znrqaJmtA7CcjG0yQESWig)

- [PaddleLite C++ å£ç½©æ£€æµ‹ç¤ºä¾‹](https://paddle-lite.readthedocs.io/zh/latest/quick_start/cpp_demo.html?highlight=%E5%8F%A3%E7%BD%A9#id10)

ä¸ºäº†èƒ½å¤Ÿä¾¿æ·å¿«é€Ÿçš„é€‚é…å„ç§è¾¹ç¼˜ç¡¬ä»¶è®¾å¤‡ï¼ˆä¾‹å¦‚<u>xilinx FPGA</u>ã€<u>Inter CPU/GPU</u>ï¼‰ï¼Œæœ¬æ–‡å°†è®­ç»ƒå¥½çš„<u>paddlepaddle</u>æ¨¡å‹è½¬åŒ–ä¸º<u>onnx</u>æ¨¡å‹ã€‚

# äºŒã€æ•°æ®é›†ä»‹ç»
- [æ•°æ®é›†é“¾æ¥](https://aistudio.baidu.com/aistudio/datasetdetail/128634)

æœ¬é¡¹ç›®ä½¿ç”¨çš„æ•°æ®é›†ç…§ç‰‡ç”±äº’è”ç½‘å›¾åƒåº“çš„çˆ¬è™«å¾—åˆ°ï¼Œå¹¶é€šè¿‡ä½¿ç”¨labelimgå®Œæˆæ ‡æ³¨å·¥ä½œï¼Œæ ‡æ³¨æ ¼å¼ä¸º<u>VOC</u>æ ¼å¼ã€‚

å…¶ä¸­ï¼Œæ•°æ®é›†æ€»å…±å«æœ‰<u>1200</u>ä¸ªæ ·æœ¬

æ•°æ®æ ‡ç­¾åªæœ‰ä¸¤ä¸ªï¼šmaskå’Œface

æ•°æ®é›†ç›®å½•æ ¼å¼å¦‚ä¸‹ï¼š

* <u>Mask/Annotations</u>ï¼šå›¾ç‰‡æ ‡æ³¨ä¿¡æ¯ï¼Œxmlæ–‡ä»¶

* <u>Mask/JPEGImages</u>ï¼šå›¾ç‰‡ï¼Œå‡ä¸ºjpgæ ¼å¼

# ä¸‰ã€å£ç½©æ•°æ®é›†çš„é¢„å¤„ç†

# ï¼ˆ1ï¼‰æ•°æ®é›†è§£å‹


```python
# æŸ¥çœ‹æŒ‚è½½çš„æ•°æ®é›†ç›®å½•
!ls /home/aistudio/data

# æ°¸ä¹…åŒ–æ•°æ®è§£å‹è·¯å¾„å’ŒPaddleDetectionå®‰è£…è·¯å¾„
!mkdir /home/aistudio/DataSet
!mkdir /home/aistudio/PaddleDetection
!mkdir /home/aistudio/Paddle2onnx

# åŒæ—¶æ·»åŠ å¦‚ä¸‹ä»£ç , è¿™æ ·æ¯æ¬¡ç¯å¢ƒ(kernel)å¯åŠ¨çš„æ—¶å€™åªè¦è¿è¡Œä¸‹æ–¹ä»£ç å³å¯: 
import sys 
sys.path.append('/home/aistudio/DataSet')
sys.path.append('/home/aistudio/PaddleDetection')
sys.path.append('/home/aistudio/Paddle2onnx')
```


```python
# è§£å‹æŒ‚è½½çš„è‡ªå®šä¹‰å£ç½©æ•°æ®é›†åˆ°dataæ–‡ä»¶å¤¹ä¸‹
!unzip -oq /home/aistudio/data/data128634/Mask.zip -d /home/aistudio/DataSet

# æŸ¥çœ‹æ•°æ®é›†çš„ç›®å½•ç»“æ„
!tree /home/aistudio/DataSet/Mask -d
```

    /home/aistudio/DataSet/Mask
    â”œâ”€â”€ Annotations
    â””â”€â”€ JPEGImages
    
    2 directories


## ï¼ˆ2ï¼‰ æ•°æ®é›†æ ·æœ¬çš„å¯è§†åŒ–


```python
# æ•°æ®é›†æ ·æœ¬çš„å¯è§†åŒ–
import cv2
import os
import numpy as np
import matplotlib.pyplot as plt
plt.rcParams['font.sans-serif'] = ['SimHei']
plt.rcParams['axes.unicode_minus'] = False
%matplotlib inline
from PIL import Image

DATA_DIR = '/home/aistudio/DataSet/Mask/JPEGImages'

file = 'train_1.jpg'

# è¯»å–å›¾ç‰‡
img = Image.open(os.path.join(DATA_DIR, file))
img = np.array(img)

# ç”»å‡ºè¯»å–çš„å›¾ç‰‡
plt.figure(figsize=(16, 8))
plt.title('pic')
plt.imshow(img)
plt.show()
```

    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/matplotlib/font_manager.py:1331: UserWarning: findfont: Font family ['sans-serif'] not found. Falling back to DejaVu Sans
      (prop.get_family(), self.defaultFamily[fontext]))



![png](output_8_1.png)


## ï¼ˆ3ï¼‰ æŒ‰æ¯”ä¾‹åˆ’åˆ†æ•°æ®é›†

è®­ç»ƒæ•°æ®é›†æ ·æœ¬æ•° ï¼š éªŒè¯æ•°æ®é›†æ ·æœ¬æ•° = <font color="red">ratio</font> : <font color="green">1 - ratio</font>

åœ¨æœ¬æ–‡ï¼Œ<font color="red">ratio</font>è®¾ç½®ä¸º0.8


```python
import random
import os
#ç”Ÿæˆtrain.txtå’Œval.txt
random.seed(2020)
xml_dir  = '/home/aistudio/DataSet/Mask/Annotations'#æ ‡ç­¾æ–‡ä»¶åœ°å€
img_dir = '/home/aistudio/DataSet/Mask/JPEGImages'#å›¾åƒæ–‡ä»¶åœ°å€
path_list = list()
for img in os.listdir(img_dir):
    img_path = os.path.join(img_dir,img)
    xml_path = os.path.join(xml_dir,img.replace('jpg', 'xml'))
    path_list.append((img_path, xml_path))
random.shuffle(path_list)
ratio = 0.8
train_f = open('/home/aistudio/work/train.txt','w') #ç”Ÿæˆè®­ç»ƒæ–‡ä»¶
val_f = open('/home/aistudio/work/val.txt' ,'w')#ç”ŸæˆéªŒè¯æ–‡ä»¶

for i ,content in enumerate(path_list):
    img, xml = content
    text = img + ' ' + xml + '\n'
    if i < len(path_list) * ratio:
        train_f.write(text)
    else:
        val_f.write(text)
train_f.close()
val_f.close()

#ç”Ÿæˆæ ‡ç­¾æ–‡æ¡£
label = ['mask','face']#è®¾ç½®ä½ æƒ³æ£€æµ‹çš„ç±»åˆ«
with open('/home/aistudio/work/label_list.txt', 'w') as f:
    for text in label:
        f.write(text+'\n')
```

## ï¼ˆ4ï¼‰å°†VOCæ•°æ®é›†è½¬åŒ–ä¸ºCOCOæ•°æ®é›†ï¼ˆå¯é€‰ï¼‰

å¦‚æœåœ¨æ¨¡å‹è®­ç»ƒæ—¶ä½¿ç”¨**COCO**æ•°æ®é›†çš„è¯ï¼Œåœ¨è¿™é‡Œéœ€è¦æ‰§è¡Œè¯¥è„šæœ¬ã€‚

åœ¨æ‰§è¡Œæ•°æ®è½¬åŒ–è„šæœ¬ä¹‹å‰éœ€è¦å…ˆå®‰è£… `PaddleDetection` å·¥å…·

åœ¨æœ¬æ–‡ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯**VOC**æ•°æ®é›†è¿›è¡Œæ¨¡å‹è®­ç»ƒï¼Œæ•…ä¸å†è½¬æ¢æ•°æ®é›†æ ‡æ³¨æ ¼å¼


```python
#!python /home/aistudio/PaddleDetection/tools/x2coco.py \
#        --dataset_type voc \
#        --voc_anno_dir /home/aistudio/DataSet/Mask/Annotations/ \
#        --voc_anno_list /home/aistudio/work/train.txt \
#        --voc_label_list /home/aistudio/work/label_list.txt \
#        --voc_out_name /home/aistudio/work/voc_train.json

#!python /home/aistudio/PaddleDetection/tools/x2coco.py \
#        --dataset_type voc \
#        --voc_anno_dir /home/aistudio/DataSet/Mask/Annotations/ \
#        --voc_anno_list /home/aistudio/work/val.txt \
#        --voc_label_list /home/aistudio/work/label_list.txt \
#        --voc_out_name /home/aistudio/work/voc_val.json
```

# å››ã€PaddleDetectionå®‰è£…ä¸ç¯å¢ƒé…ç½®


```python
# å…‹éš†paddledetectionä»“åº“
!git clone https://gitee.com/PaddlePaddle/PaddleDetection.git -b release/2.3
```

    Cloning into 'PaddleDetection'...
    remote: Enumerating objects: 21396, done.[K
    remote: Counting objects: 100% (1866/1866), done.[K
    remote: Compressing objects: 100% (934/934), done.[K
    remote: Total 21396 (delta 1313), reused 1301 (delta 929), pack-reused 19530[K
    Receiving objects: 100% (21396/21396), 202.22 MiB | 17.38 MiB/s, done.
    Resolving deltas: 100% (15862/15862), done.
    Checking connectivity... done.



```python
# å®‰è£…æ‰€éœ€ä¾èµ–é¡¹
# å·²ç»é…ç½®è¿‡ä¸€æ¬¡ä¾¿ä¸éœ€è¦æ‰§è¡Œä¸‹é¢ä¸€è¡Œçš„é…ç½®ä»£ç 
!pip install -r /home/aistudio/PaddleDetection/requirements.txt
```


```python
%cd /home/aistudio/PaddleDetection/
!pip install paddledet
```


```python
# æµ‹è¯•ä¸€ä¸‹ç¯å¢ƒæ˜¯å¦æˆåŠŸæ­å»º
%cd /home/aistudio/PaddleDetection/
!python ppdet/modeling/tests/test_architectures.py
```

    /home/aistudio/PaddleDetection
    W0224 18:10:35.777540   464 device_context.cc:447] Please NOTE: device: 0, GPU Compute Capability: 7.0, Driver API Version: 10.1, Runtime API Version: 10.1
    W0224 18:10:35.782413   464 device_context.cc:465] device: 0, cuDNN Version: 7.6.
    .......
    ----------------------------------------------------------------------
    Ran 7 tests in 3.654s
    
    OK


OK!è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†<u>æ•°æ®é›†çš„é¢„å¤„ç†</u>å’Œ<u>ç¯å¢ƒçš„æ­å»º</u>å·¥ä½œã€‚

ä¸‹é¢å°†è¿›å…¥åˆ°æœ€ä¸ºé‡è¦çš„ä¸€ç¯ï¼š**æ¨¡å‹è®­ç»ƒ**

# äº”ã€æ¨¡å‹é€‰æ‹©å¹¶è®­ç»ƒ

## ï¼ˆ1ï¼‰ æ¨¡å‹é€‰æ‹©ä¸ä»‹ç»
ç”±äºåœ¨æœªæ¥æœ‰è®¡åˆ’å°†è¯¥å£ç½©æ£€æµ‹ä»»åŠ¡éƒ¨ç½²åˆ°è¾¹ç¼˜ç«¯ï¼Œå†è€ƒè™‘åˆ°æ¨¡å‹ç²¾åº¦é—®é¢˜ï¼Œæˆ‘é€‰æ‹©ä½¿ç”¨**PaddleDetection**ä¸‹çš„**PP-YOLOv2**æ¨¡å‹å®Œæˆæ¨¡å‹è®­ç»ƒçš„å·¥ä½œã€‚

**PP-YOLOv2 æ¨¡å‹ç®€ä»‹**

ç›¸è¾ƒ20å¹´å‘å¸ƒçš„PP-YOLOï¼Œv2ç‰ˆæœ¬åœ¨COCO 2017 test-devä¸Šçš„ç²¾åº¦æå‡äº†3.6ä¸ªç™¾åˆ†ç‚¹ï¼Œç”±45.9%æå‡åˆ°äº†49.5%ï¼›åœ¨640*640çš„è¾“å…¥å°ºå¯¸ä¸‹ï¼ŒFPSè¾¾åˆ°68.9FPSã€‚ PP-YOLOv2åœ¨åŒç­‰é€Ÿåº¦ä¸‹ï¼Œç²¾åº¦è¶…è¶ŠYOLOv5ï¼

<div align="center">
  <img src="https://ai-studio-static-online.cdn.bcebos.com/3f0ca399f712482a9ebb1c32ebe6945d69bb610e3aa849a89a4f80910c5c763c" width=500 />
</div>


**PP-YOLOæ¨¡å‹åº“**

|          Model           | GPU number | images/GPU |  backbone  | input shape | Box AP<sup>val</sup> | Box AP<sup>test</sup> | V100 FP32(FPS) | V100 TensorRT FP16(FPS) | download | config  |
|:------------------------:|:-------:|:-------------:|:----------:| :-------:| :------------------: | :-------------------: | :------------: | :---------------------: | :------: | :------: |
| PP-YOLO                  |     8      |     24     | ResNet50vd |     608     |         44.8         |         45.2          |      72.9      |          155.6          | [model](https://paddledet.bj.bcebos.com/models/ppyolo_r50vd_dcn_1x_coco.pdparams) | [config](https://github.com/PaddlePaddle/PaddleDetection/tree/release/2.0/configs/ppyolo/ppyolo_r50vd_dcn_1x_coco.yml)                   |
| PP-YOLO                  |     8      |     24     | ResNet50vd |     512     |         43.9         |         44.4          |      89.9      |          188.4          | [model](https://paddledet.bj.bcebos.com/models/ppyolo_r50vd_dcn_1x_coco.pdparams) | [config](https://github.com/PaddlePaddle/PaddleDetection/tree/release/2.0/configs/ppyolo/ppyolo_r50vd_dcn_1x_coco.yml)                   |
| PP-YOLO                  |     8      |     24     | ResNet50vd |     416     |         42.1         |         42.5          |      109.1      |          215.4          | [model](https://paddledet.bj.bcebos.com/models/ppyolo_r50vd_dcn_1x_coco.pdparams) | [config](https://github.com/PaddlePaddle/PaddleDetection/tree/release/2.0/configs/ppyolo/ppyolo_r50vd_dcn_1x_coco.yml)                   |
| PP-YOLO                  |     8      |     24     | ResNet50vd |     320     |         38.9         |         39.3          |      132.2      |          242.2          | [model](https://paddledet.bj.bcebos.com/models/ppyolo_r50vd_dcn_1x_coco.pdparams) | [config](https://github.com/PaddlePaddle/PaddleDetection/tree/release/2.0/configs/ppyolo/ppyolo_r50vd_dcn_1x_coco.yml)                   |
| PP-YOLO_2x               |     8      |     24     | ResNet50vd |     608     |         45.3         |         45.9          |      72.9      |          155.6          | [model](https://paddledet.bj.bcebos.com/models/ppyolo_r50vd_dcn_2x_coco.pdparams) | [config](https://github.com/PaddlePaddle/PaddleDetection/tree/release/2.0/configs/ppyolo/ppyolo_r50vd_dcn_2x_coco.yml)                   |
| PP-YOLO_2x               |     8      |     24     | ResNet50vd |     512     |         44.4         |         45.0          |      89.9      |          188.4          | [model](https://paddledet.bj.bcebos.com/models/ppyolo_r50vd_dcn_2x_coco.pdparams) | [config](https://github.com/PaddlePaddle/PaddleDetection/tree/release/2.0/configs/ppyolo/ppyolo_r50vd_dcn_2x_coco.yml)                   |
| PP-YOLO_2x               |     8      |     24     | ResNet50vd |     416     |         42.7         |         43.2          |      109.1      |          215.4          | [model](https://paddledet.bj.bcebos.com/models/ppyolo_r50vd_dcn_2x_coco.pdparams) | [config](https://github.com/PaddlePaddle/PaddleDetection/tree/release/2.0/configs/ppyolo/ppyolo_r50vd_dcn_2x_coco.yml)                   |
| PP-YOLO_2x               |     8      |     24     | ResNet50vd |     320     |         39.5         |         40.1          |      132.2      |          242.2          | [model](https://paddledet.bj.bcebos.com/models/ppyolo_r50vd_dcn_2x_coco.pdparams) | [config](https://github.com/PaddlePaddle/PaddleDetection/tree/release/2.0/configs/ppyolo/ppyolo_r50vd_dcn_2x_coco.yml)                   |
| PP-YOLO               |     4      |     32     | ResNet18vd |     512     |         29.2         |         29.5          |      357.1      |          657.9          | [model](https://paddledet.bj.bcebos.com/models/ppyolo_r18vd_coco.pdparams) | [config](https://github.com/PaddlePaddle/PaddleDetection/tree/release/2.0/configs/ppyolo/ppyolo_r18vd_coco.yml)                   |
| PP-YOLO               |     4      |     32     | ResNet18vd |     416     |         28.6         |         28.9          |      409.8      |          719.4          | [model](https://paddledet.bj.bcebos.com/models/ppyolo_r18vd_coco.pdparams) | [config](https://github.com/PaddlePaddle/PaddleDetection/tree/release/2.0/configs/ppyolo/ppyolo_r18vd_coco.yml)                   |
| PP-YOLO               |     4      |     32     | ResNet18vd |     320     |         26.2         |         26.4          |      480.7      |          763.4          | [model](https://paddledet.bj.bcebos.com/models/ppyolo_r18vd_coco.pdparams) | [config](https://github.com/PaddlePaddle/PaddleDetection/tree/release/2.0/configs/ppyolo/ppyolo_r18vd_coco.yml)                   |
| PP-YOLOv2               |     8      |     12     | ResNet50vd |     640     |         49.1         |         49.5          |      68.9      |          106.5          | [model](https://paddledet.bj.bcebos.com/models/ppyolov2_r50vd_dcn_365e_coco.pdparams) | [config](https://github.com/PaddlePaddle/PaddleDetection/tree/release/2.0/configs/ppyolo/ppyolov2_r50vd_dcn_365e_coco.yml)                   |
| PP-YOLOv2               |     8      |     12     | ResNet101vd |     640     |         49.7         |         50.3          |     49.5     |         87.0         | [model](https://paddledet.bj.bcebos.com/models/ppyolov2_r101vd_dcn_365e_coco.pdparams) | [config](https://github.com/PaddlePaddle/PaddleDetection/tree/release/2.0/configs/ppyolo/ppyolov2_r101vd_dcn_365e_coco.yml)                   |


**æ³¨æ„:**

- PP-YOLOæ¨¡å‹ä½¿ç”¨COCOæ•°æ®é›†ä¸­train2017ä½œä¸ºè®­ç»ƒé›†ï¼Œä½¿ç”¨val2017å’Œtest-dev2017ä½œä¸ºæµ‹è¯•é›†ï¼ŒBox AP<sup>test</sup>ä¸º`mAP(IoU=0.5:0.95)`è¯„ä¼°ç»“æœã€‚
- PP-YOLOæ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­ä½¿ç”¨8 GPUsï¼Œæ¯GPU batch sizeä¸º24è¿›è¡Œè®­ç»ƒï¼Œå¦‚è®­ç»ƒGPUæ•°å’Œbatch sizeä¸ä½¿ç”¨ä¸Šè¿°é…ç½®ï¼Œé¡»å‚è€ƒ[FAQ](https://github.com/PaddlePaddle/PaddleDetection/blob/release/2.0/static/docs/FAQ.md)è°ƒæ•´å­¦ä¹ ç‡å’Œè¿­ä»£æ¬¡æ•°ã€‚
- PP-YOLOæ¨¡å‹æ¨ç†é€Ÿåº¦æµ‹è¯•é‡‡ç”¨å•å¡V100ï¼Œbatch size=1è¿›è¡Œæµ‹è¯•ï¼Œä½¿ç”¨CUDA 10.2, CUDNN 7.5.1ï¼ŒTensorRTæ¨ç†é€Ÿåº¦æµ‹è¯•ä½¿ç”¨TensorRT 5.1.2.2ã€‚
- PP-YOLOæ¨¡å‹FP32çš„æ¨ç†é€Ÿåº¦æµ‹è¯•æ•°æ®ä¸ºä½¿ç”¨`tools/export_model.py`è„šæœ¬å¯¼å‡ºæ¨¡å‹åï¼Œä½¿ç”¨`deploy/python/infer.py`è„šæœ¬ä¸­çš„`--run_benchnark`å‚æ•°ä½¿ç”¨Paddleé¢„æµ‹åº“è¿›è¡Œæ¨ç†é€Ÿåº¦benchmarkæµ‹è¯•ç»“æœ, ä¸”æµ‹è¯•çš„å‡ä¸ºä¸åŒ…å«æ•°æ®é¢„å¤„ç†å’Œæ¨¡å‹è¾“å‡ºåå¤„ç†(NMS)çš„æ•°æ®(ä¸[YOLOv4(AlexyAB)](https://github.com/AlexeyAB/darknet)æµ‹è¯•æ–¹æ³•ä¸€è‡´)ã€‚
- TensorRT FP16çš„é€Ÿåº¦æµ‹è¯•ç›¸æ¯”äºFP32å»é™¤äº†`yolo_box`(bboxè§£ç )éƒ¨åˆ†è€—æ—¶ï¼Œå³ä¸åŒ…å«æ•°æ®é¢„å¤„ç†ï¼Œbboxè§£ç å’ŒNMS(ä¸[YOLOv4(AlexyAB)](https://github.com/AlexeyAB/darknet)æµ‹è¯•æ–¹æ³•ä¸€è‡´)ã€‚

## ï¼ˆ2ï¼‰ ä¿®æ”¹é…ç½®æ–‡ä»¶
è¿™é‡Œä½¿ç”¨çš„é…ç½®æ–‡ä»¶æ˜¯ `/home/aistudio/PaddleDetection/configs/ppyolo/ppyolov2_r50vd_dcn_voc.yml` æ–‡ä»¶

ä¸‹é¢ä»‹ç»ä¸€ä¸‹é…ç½®æ–‡ä»¶é‡Œé¢çš„å‚æ•°è¡¨è¾¾çš„æ„æ€

 `../datasets/voc.yml`ä¸»è¦è¯´æ˜äº†è®­ç»ƒæ•°æ®å’ŒéªŒè¯æ•°æ®çš„è·¯å¾„

 `../runtime.yml`ä¸»è¦è¯´æ˜äº†å…¬å…±çš„è¿è¡Œå‚æ•°ï¼Œæ¯”å¦‚è¯´æ˜¯å¦ä½¿ç”¨GPUã€æ¯å¤šå°‘ä¸ªepochå­˜å‚¨checkpointç­‰

 `./_base_/ppyolov2_r50vd_dcn.yml` ä¸»è¦è¯´æ˜æ¨¡å‹ã€å’Œä¸»å¹²ç½‘ç»œçš„æƒ…å†µã€‚

 `./_base_/optimizer_365e.yml`ä¸»è¦è¯´æ˜äº†å­¦ä¹ ç‡å’Œä¼˜åŒ–å™¨çš„é…ç½®ã€‚

 `./_base_/ppyolov2_reader.yml`ä¸»è¦è¯´æ˜æ•°æ®è¯»å–å™¨é…ç½®ï¼Œå¦‚batch sizeï¼Œå¹¶å‘åŠ è½½å­è¿›ç¨‹æ•°ç­‰ï¼ŒåŒæ—¶åŒ…å«è¯»å–åé¢„å¤„ç†æ“ä½œï¼Œå¦‚resizeã€æ•°æ®å¢å¼ºç­‰ç­‰

**ä¿®æ”¹éƒ¨åˆ†ï¼š**

éœ€è¦ä¿®æ”¹æ•°æ®é›†çš„è·¯å¾„ï¼Œå³å¯¹åº”çš„çº¢è‰²éƒ¨åˆ†

`PaddleDetection/configs/datasets/voc.yml`


![](https://ai-studio-static-online.cdn.bcebos.com/b8071d5be95b4cbdac50d9be69182ce6352e2098580a4f138970c6c008468e50)


ç„¶åè¿›å…¥ `PaddleDetection/configs/ppyolo/_base_/optimizer_365e.yml` ,ä¿®æ”¹**epoch**æ”¹ä¸º300æ¬¡,ä¿®æ”¹**å­¦ä¹ ç‡lr**ä¸º0.0025

![](https://ai-studio-static-online.cdn.bcebos.com/42cc7c65537b4b358595700a376faaff986df883bba74174b38288e6e1afcb88)


è¿˜éœ€è¦è¿›å…¥ `/home/aistudio/PaddleDetection/configs/ppyolo/ppyolov2_r50vd_dcn_voc.yml` ï¼Œä¿®æ”¹epochã€snapshot

![](https://ai-studio-static-online.cdn.bcebos.com/814466887cb44f009e0020151c46960ae0d11afca31e431b9a5e330a8e94ebf2)



å¦‚æœçˆ†å†…å­˜å°±ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶çš„batch_sizeï¼š

`PaddleDetection/configs/ppyolo/_base_/ppyolov2_reader.yml`


åœ¨è¿™é‡Œæˆ‘å°†batchsizeæ”¹ä¸º4


![](https://ai-studio-static-online.cdn.bcebos.com/b5e7e2696aa74a7eb433b28a3dabc10af923d19ead1647ab8b982ba12835fb5e)

## ï¼ˆ3ï¼‰æ¨¡å‹è®­ç»ƒ

ä½¿ç”¨GPUé€šè¿‡å¦‚ä¸‹å‘½ä»¤ä¸€é”®å¼å¯åŠ¨è®­ç»ƒ(ä»¥ä¸‹å‘½ä»¤å‡é»˜è®¤åœ¨PaddleDetectionæ ¹ç›®å½•è¿è¡Œ), é€šè¿‡`--eval`å‚æ•°å¼€å¯è®­ç»ƒä¸­äº¤æ›¿è¯„ä¼°ã€‚

```bash
CUDA_VISIBLE_DEVICES=0 python tools/train.py -c configs/ppyolo/ppyolo.yml --eval
```
å¯é€‰ï¼šåœ¨è®­ç»ƒä¹‹å‰ä½¿ç”¨`tools/anchor_cluster.py`å¾—åˆ°é€‚ç”¨äºä½ çš„æ•°æ®é›†çš„anchorï¼Œå¹¶ä¿®æ”¹`configs/ppyolo/ppyolo.yml`ä¸­çš„anchorè®¾ç½®
```bash
python tools/anchor_cluster.py -c configs/ppyolo/ppyolo.yml -n 9 -s 608 -m v2 -i 1000
```


```python
# å¼€å§‹è®­ç»ƒ
%cd /home/aistudio/PaddleDetection/
!CUDA_VISIBLE_DEVICES=0
!python tools/train.py \
    -c configs/ppyolo/ppyolov2_r50vd_dcn_voc.yml \
    --resume output/ppyolov2_r50vd_dcn_voc/89.pdparams \
    --eval
```

## ï¼ˆ4ï¼‰æ¨¡å‹ä¿å­˜

æ¨¡å‹è®­ç»ƒç»“æœä¿å­˜åœ¨ `/home/aistudio/PaddleDetection/output/ppyolov2_r50vd_dcn_voc` ç›®å½•ä¸‹

ä¸‹é¢å°†æ•ˆæœæœ€å¥½çš„æ¨¡å‹å‚æ•°å¦å­˜åˆ° `/home/aistudio/work` ç›®å½•ä¸‹


```python
!cp /home/aistudio/PaddleDetection/output/ppyolov2_r50vd_dcn_voc/best_model.pdopt /home/aistudio/work
!cp /home/aistudio/PaddleDetection/output/ppyolov2_r50vd_dcn_voc/best_model.pdparams /home/aistudio/work
```

# å…­ã€æ¨¡å‹é¢„æµ‹

## ï¼ˆ1ï¼‰æ¨¡å‹è¯„ä¼°


```python
%cd /home/aistudio/PaddleDetection/
!python -u tools/eval.py -c configs/ppyolo/ppyolov2_r50vd_dcn_voc.yml -o weights=/home/aistudio/work/best_model.pdparams
```

    /home/aistudio/PaddleDetection
    Warning: import ppdet from source directory without installing, run 'python setup.py install' to install ppdet firstly
    W0224 17:15:36.664734  8835 device_context.cc:447] Please NOTE: device: 0, GPU Compute Capability: 7.0, Driver API Version: 10.1, Runtime API Version: 10.1
    W0224 17:15:36.670354  8835 device_context.cc:465] device: 0, cuDNN Version: 7.6.
    [02/24 17:15:41] ppdet.utils.checkpoint INFO: Finish loading model weights: /home/aistudio/work/best_model.pdparams
    [02/24 17:15:41] ppdet.engine INFO: Eval iter: 0
    [02/24 17:15:45] ppdet.engine INFO: Eval iter: 100
    [02/24 17:15:50] ppdet.engine INFO: Eval iter: 200
    [02/24 17:15:52] ppdet.metrics.metrics INFO: Accumulating evaluatation results...
    [02/24 17:15:52] ppdet.metrics.metrics INFO: mAP(0.50, 11point) = 84.34%
    [02/24 17:15:52] ppdet.engine INFO: Total sample number: 240, averge FPS: 21.633217941323505


**ä»æ¨¡å‹è¯„ä¼°ç»“æœå¯ä»¥çœ‹å¾—å‡ºï¼ŒmAPå¯è¾¾åˆ°80+ï¼Œæ¨¡å‹ç²¾åº¦å°šå¯**

![](https://ai-studio-static-online.cdn.bcebos.com/8e5650661a05483281bf420029d325a7cd836aedad264d74a953cb6b71945617)


## ï¼ˆ2ï¼‰æ¨¡å‹é¢„æµ‹


```python
# å°†å¾…é¢„æµ‹å›¾ç‰‡è¾“å…¥åˆ°æ¨¡å‹
%cd /home/aistudio/PaddleDetection/
!python tools/infer.py \
        -c configs/ppyolo/ppyolov2_r50vd_dcn_voc.yml \
        -o weights=/home/aistudio/work/best_model.pdparams \
        --infer_img=/home/aistudio/test.jpg
```

    /home/aistudio/PaddleDetection
    Warning: import ppdet from source directory without installing, run 'python setup.py install' to install ppdet firstly
    W0224 17:19:41.804229  9267 device_context.cc:447] Please NOTE: device: 0, GPU Compute Capability: 7.0, Driver API Version: 10.1, Runtime API Version: 10.1
    W0224 17:19:41.809790  9267 device_context.cc:465] device: 0, cuDNN Version: 7.6.
    [02/24 17:19:45] ppdet.utils.checkpoint INFO: Finish loading model weights: /home/aistudio/work/best_model.pdparams
    [02/24 17:19:46] ppdet.engine INFO: Detection bbox results save in output/test.jpg


**æ¨¡å‹æ¨ç†ç»“æœä¿å­˜åœ¨ `PaddleDetection/output` è·¯å¾„ä¸‹**


```python
#å°†è¾“å‡ºç»“æœæ‹·è´åˆ°/home/aistudio/workç›®å½•ä¸‹
!cp /home/aistudio/PaddleDetection/output/test.jpg /home/aistudio/work
```

## ï¼ˆ3ï¼‰å¯è§†åŒ–æ¨¡å‹é¢„æµ‹æ•ˆæœ


```python
# åŒæ—¶å±•ç¤ºåŸå›¾åƒå’Œæ¨¡å‹é¢„æµ‹çš„ç»“æœ
import cv2
import os
import numpy as np
import matplotlib.pyplot as plt
plt.rcParams['font.sans-serif'] = ['SimHei']
plt.rcParams['axes.unicode_minus'] = False
%matplotlib inline
from PIL import Image

# è¯»å–å›¾ç‰‡
original = Image.open('/home/aistudio/test.jpg')
original = np.array(original)
result = Image.open('/home/aistudio/work/test.jpg')
result = np.array(result)

# ç”»å‡ºè¯»å–çš„å›¾ç‰‡
plt.figure(figsize=(20, 10))
f = plt.subplot(121)
f.set_title('origin', fontsize=20)
plt.imshow(original)
f = plt.subplot(122)
f.set_title('result', fontsize=20)
plt.imshow(result)
plt.show()
```

    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/matplotlib/font_manager.py:1331: UserWarning: findfont: Font family ['sans-serif'] not found. Falling back to DejaVu Sans
      (prop.get_family(), self.defaultFamily[fontext]))



![png](output_35_1.png)


**å¯ä»¥æ¸…æ™°çš„çœ‹è§å›¾ç‰‡ä¸­æ‰€æœ‰æˆ´å£ç½©çš„äººè„¸å…¨è¢«é¢„æµ‹å‡ºæ¥**


![](https://ai-studio-static-online.cdn.bcebos.com/ed614893e74446c3809db651578edf35c678e3c751e64d3d87e8b81269be019d)



# ä¸ƒã€å¯¼å‡ºæ¨¡å‹


```python
# å¯¼å‡ºæ¨¡å‹
!cd /home/aistudio/PaddleDetection/
!python tools/export_model.py \
        -c /home/aistudio/PaddleDetection/configs/ppyolo/ppyolov2_r50vd_dcn_voc.yml \
        -o weights=/home/aistudio/work/best_model.pdparams \
        --output_dir /home/aistudio/output
```

    Warning: import ppdet from source directory without installing, run 'python setup.py install' to install ppdet firstly
    [02/24 17:21:58] ppdet.utils.checkpoint INFO: Finish loading model weights: /home/aistudio/work/best_model.pdparams
    [02/24 17:21:58] ppdet.engine INFO: Export inference config file to /home/aistudio/output/ppyolov2_r50vd_dcn_voc/infer_cfg.yml
    W0224 17:22:04.055876  9470 device_context.cc:447] Please NOTE: device: 0, GPU Compute Capability: 7.0, Driver API Version: 10.1, Runtime API Version: 10.1
    W0224 17:22:04.055944  9470 device_context.cc:465] device: 0, cuDNN Version: 7.6.
    [02/24 17:22:09] ppdet.engine INFO: Export model and saved in /home/aistudio/output/ppyolov2_r50vd_dcn_voc


## Netron -- æ¨¡å‹ç»“æ„å¯è§†åŒ–


```python
# å®‰è£…netron
!pip install netron
```

    Looking in indexes: https://pypi.tuna.tsinghua.edu.cn/simple
    Collecting netron
      Downloading https://pypi.tuna.tsinghua.edu.cn/packages/5b/98/bd12f37940c8f90b09146d8259f5c99d4e30d38b33a1b9a04c0c89401cff/netron-5.5.9-py2.py3-none-any.whl (1.4 MB)
         |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1.4 MB 3.5 MB/s            
    [?25hInstalling collected packages: netron
    Successfully installed netron-5.5.9
    [33mWARNING: You are using pip version 21.3.1; however, version 22.0.3 is available.
    You should consider upgrading via the '/opt/conda/envs/python35-paddle120-env/bin/python -m pip install --upgrade pip' command.[0m



```python
# é€šè¿‡netronæŸ¥çœ‹ç½‘ç»œç»“æ„
!netron /home/aistudio/output/ppyolov2_r50vd_dcn_voc/model.pdmodel
```

    Serving '/home/aistudio/output/ppyolov2_r50vd_dcn_voc/model.pdmodel' at http://localhost:8080
    ^C
    
    Stopping http://localhost:8080


**ç”±äºæ¨¡å‹å¤æ‚ï¼Œä¸‹å›¾åªå±•ç¤ºæ¨¡å‹é¡¶éƒ¨headå±‚çš„ç»“æ„ï¼š**

![](https://ai-studio-static-online.cdn.bcebos.com/4544644cabb240f6918ba505828b46e4afd9edbd68b9430082c1c84ae5776795)


# å…«ã€å°†paddleæ¨¡å‹è½¬åŒ–ä¸ºonnx

## ï¼ˆ1ï¼‰onnxä»‹ç»

ONNX (Open Neural Network Exchange) æ˜¯é’ˆå¯¹æœºå™¨å­¦ä¹ æ‰€è®¾è®¡çš„å¼€æºæ–‡ä»¶æ ¼å¼ï¼Œç”¨äºå­˜å‚¨è®­ç»ƒå¥½çš„æ¨¡å‹ã€‚å®ƒä½¿å¾—ä¸åŒçš„äººå·¥æ™ºèƒ½æ¡†æ¶å¯ä»¥é‡‡ç”¨ç›¸åŒæ ¼å¼å­˜å‚¨æ¨¡å‹å¹¶äº¤äº’ã€‚é€šè¿‡ONNXæ ¼å¼ï¼ŒPaddleæ¨¡å‹å¯ä»¥ä½¿ç”¨OpenVINOã€ONNX Runtimeç­‰æ¡†æ¶è¿›è¡Œæ¨ç†ã€‚å‡è®¾ä¸€ä¸ªæ¨¡å‹é€šè¿‡å­¦ä¹ æ¡†æ¶è®­ç»ƒå¥½åï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒå­˜å‚¨ä¸‹æ¥ï¼Œç„¶åå­˜å‚¨çš„æ ¼å¼å¯ä»¥ä½¿ç”¨ONNXçš„è¿™ç§æ ¼å¼ï¼Œåœ¨æ¨¡å‹ä¸­æ¨¡å‹æ„é€ æ˜¯æœ‰å‘æ— ç¯çš„ï¼Œå›¾é‡Œé¢å®ƒæœ‰å¾ˆå¤šçš„èŠ‚ç‚¹ï¼Œç„¶åæ¯ä¸€ä¸ªèŠ‚ç‚¹ä¼šæœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªçš„è¾“å…¥ï¼Œå¹¶ä¸”è¿™ä¸ªèŠ‚ä¹Ÿä¼šæœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªçš„è¾“å‡ºã€‚è¿™äº›è¾“å…¥å’Œè¾“å‡ºå°±å¯ä»¥æ„æˆä¸€å‰¯å®Œæ•´çš„å›¾ã€‚æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯éƒ½æˆä¸ºä¸€ä¸ªOPã€‚

![](https://docs.microsoft.com/zh-cn/azure/machine-learning/media/concept-onnx/onnx.png#lightbox)

æœ‰äº†ONNXæ¨¡å‹åï¼Œä¸åŒçš„ç®—æ³•æ¶æ„çš„æ¨¡å‹ä¹Ÿå¯ä»¥ä½¿ç”¨ç›¸åŒçš„è¿™ç§æ–‡ä»¶æ ¼å¼è¿›è¡Œå­˜å‚¨ã€‚

å®é™…ä¸­å¯èƒ½é‡åˆ°è¿™æ ·å­ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœä½ é‡åˆ°å¾ˆå¥½çš„ä¸€ä¸ªpytorchæ¨¡å‹ï¼Œä½†æ˜¯ä½ æ— æ³•è·å–ä»–ä»¬çš„æ•°æ®é›†ï¼Œæˆ–è€…æ²¡æœ‰ç¡¬ä»¶æ¡ä»¶å»æ”¯æ’‘è®¾å¤‡ã€‚åœ¨è¿™ä¸ªæ—¶å€™ç§‘å­¦é‚£æˆ‘ä»¬å°±æœ‰ä¸€ä¸ªå¾ˆå¥½çš„æƒ³æ³•ï¼Œå°±æ˜¯è¯´æŠŠpytorchè¿™ä¸ªæ¨¡å‹å‘¢ï¼Œç›´æ¥è¿ç§»è¿‡æ¥ï¼Œç„¶åè¿›è¡Œéƒ¨ç½²å°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚åœ¨è¿™é‡Œï¼Œå°±æä¾›ä¸€ç§æ–°çš„è§£å†³æ–¹æ¡ˆï¼Œå°±æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ONNXæ¥å—çš„è½¬æ¢æ ¼å¼ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†æƒ³è¦è½¬æ¢çš„pytorchæ¨¡å‹ä¿å­˜å‡ºæ¥ï¼Œä¿å­˜æˆä¸€ä¸ªONNXæ ¼å¼ï¼Œä¿å­˜ä¹‹åå‘¢ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯ONNXæ ¼å¼ï¼Œå®ƒå¯ä»¥é€šè¿‡ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬çš„æ“ä½œpaddleXï¼ˆpaddleçš„ä¸€ä¸ªå·¥å…·å¥—ä»¶ï¼‰è¿›è¡Œè½¬æ¢ã€‚ç„¶åå°±å¯ä»¥è½¬æ¢æˆæˆ‘ä»¬çš„ä¸€ä¸ªpaddleçš„ä¸€ä¸ªinferenceæ¨¡å‹ã€‚ä¹‹åå°±å¯ä»¥é€šè¿‡è¿™ä¸ªinferenceæ¨¡å‹å»è¿›è¡Œéƒ¨ç½²äº†ã€‚

## ï¼ˆ2ï¼‰paddle2onnxç®€ä»‹
é£æ¡¨æ˜¯å›½å†…æœ€æ—©å¼€æºçš„æ¡†æ¶ï¼Œæ—©å°±å·²ç»å’ŒONNXè¿›è¡Œäº†æ·±å…¥çš„åˆä½œï¼Œä¹Ÿå¼€æºäº†paddle2ONNXä½œä¸ºpaddle paddleçš„ä¸€ä¸ªæ ¸å¿ƒæ¨¡å—ï¼Œç„¶åæ”¯æŒå°†paddlepaddleæ¡†æ¶è®­ç»ƒçš„è¿™ä¸ªæ¨¡å‹ç›´æ¥ä¿å­˜ä¸ºONNXæ ¼å¼æ¥å¸®åŠ©æˆ‘ä»¬çš„å¼€å‘è€…å¿«é€Ÿåœ°å°†æˆ‘ä»¬çš„paddleæ¨¡å‹é«˜é€Ÿã€é«˜æ•ˆã€çµæ´»åœ°éƒ¨ç½²åˆ°å„ç§ä¸»æµçš„å¹³å°ä¸Šã€‚

ç®€è€Œè¨€ä¹‹ï¼Œ**ONNXæ˜¯ç›´æ¥ä½¿ç”¨paddleæ¨¡å‹åˆ°åˆ°å„ç§å¹³å°ä¸Šçš„ä¸€ä¸ªæ¡¥æ¢ã€‚**

## ï¼ˆ3ï¼‰ç¯å¢ƒå‡†å¤‡
å®‰è£…ä¾èµ– è¿™é‡Œé¦–å…ˆè¦å®‰è£…çš„æ˜¯pycocotoolsã€paddle2onnxã€onnxruntimeï¼Œç¬¬ä¸‰ä¸ªæ˜¯æˆ‘ä»¬åˆ°æ—¶å€™éƒ¨ç½²éªŒè¯çš„æ—¶å€™ä¼šä½¿ç”¨åˆ°onnxruntimeï¼Œç¬¬ä¸€ä¸ªæ˜¯pycocotoolsï¼ˆpython api tools of COCOï¼‰ç”¨æ¥å¤„ç†COCOçš„æ•°æ®é›†ã€‚ä¸€å®šè¦åˆ¶å®šonnxçš„ç‰ˆæœ¬ï¼Œä»–éœ€è¦å°äº1.9.0ã€‚


```python
!pip install pycocotools paddle2onnx onnxruntime
```


```python
!pip install onnx==1.9.0
```


```python
# å…‹éš†paddle2onnx
!git clone https://github.com/PaddlePaddle/paddle2onnx.git /home/aistudio/Paddle2onnx/
```

    Cloning into '/home/aistudio/Paddle2onnx'...
    remote: Enumerating objects: 5302, done.[K
    remote: Counting objects: 100% (2333/2333), done.[K
    remote: Compressing objects: 100% (814/814), done.[K
    remote: Total 5302 (delta 1988), reused 1675 (delta 1516), pack-reused 2969[K
    Receiving objects: 100% (5302/5302), 2.34 MiB | 0 bytes/s, done.
    Resolving deltas: 100% (3513/3513), done.
    Checking connectivity... done.



```python
# å®‰è£…paddle2onnx
!python /home/aistudio/Paddle2onnx/setup.py install
```

## ï¼ˆ4ï¼‰å°†æ¨¡å‹è½¬åŒ–ä¸ºonnx

![](https://ai-studio-static-online.cdn.bcebos.com/30da041155694be9a8b45b624282f8f9f79e7e996c174e7f93932955135ab5c6)


```python
!paddle2onnx \
        --model_dir /home/aistudio/output/ppyolov2_r50vd_dcn_voc \
        --model_filename model.pdmodel \
        --params_filename model.pdiparams \
        --save_file /home/aistudio/ppyolov2_voc.onnx \
        --opset_version 12 \
        --enable_onnx_checker True
```

    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle/fluid/framework.py:2253: UserWarning: The Attr(force_cpu) of Op(fill_constant) will be deprecated in the future, please use 'device_guard' instead. 'device_guard' has higher priority when they are used at the same time.
      "used at the same time." % type)
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle/fluid/layers/math_op_patch.py:341: UserWarning: /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle2onnx/op_mapper/custom_paddle_op/deformable_conv.py:212
    The behavior of expression A - B has been unified with elementwise_sub(X, Y, axis=-1) from Paddle 2.0. If your code works well in the older versions but crashes in this version, try to use elementwise_sub(X, Y, axis=0) instead of A - B. This transitional warning will be dropped in the future.
      op_type, op_type, EXPRESSION_MAP[method_name]))
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle/fluid/layers/math_op_patch.py:341: UserWarning: /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle2onnx/op_mapper/custom_paddle_op/deformable_conv.py:215
    The behavior of expression A - B has been unified with elementwise_sub(X, Y, axis=-1) from Paddle 2.0. If your code works well in the older versions but crashes in this version, try to use elementwise_sub(X, Y, axis=0) instead of A - B. This transitional warning will be dropped in the future.
      op_type, op_type, EXPRESSION_MAP[method_name]))
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle/fluid/layers/math_op_patch.py:341: UserWarning: /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle2onnx/op_mapper/custom_paddle_op/deformable_conv.py:215
    The behavior of expression A * B has been unified with elementwise_mul(X, Y, axis=-1) from Paddle 2.0. If your code works well in the older versions but crashes in this version, try to use elementwise_mul(X, Y, axis=0) instead of A * B. This transitional warning will be dropped in the future.
      op_type, op_type, EXPRESSION_MAP[method_name]))
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle/fluid/layers/math_op_patch.py:341: UserWarning: /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle2onnx/op_mapper/custom_paddle_op/deformable_conv.py:217
    The behavior of expression A - B has been unified with elementwise_sub(X, Y, axis=-1) from Paddle 2.0. If your code works well in the older versions but crashes in this version, try to use elementwise_sub(X, Y, axis=0) instead of A - B. This transitional warning will be dropped in the future.
      op_type, op_type, EXPRESSION_MAP[method_name]))
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle/fluid/layers/math_op_patch.py:341: UserWarning: /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle2onnx/op_mapper/custom_paddle_op/deformable_conv.py:220
    The behavior of expression A - B has been unified with elementwise_sub(X, Y, axis=-1) from Paddle 2.0. If your code works well in the older versions but crashes in this version, try to use elementwise_sub(X, Y, axis=0) instead of A - B. This transitional warning will be dropped in the future.
      op_type, op_type, EXPRESSION_MAP[method_name]))
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle/fluid/layers/math_op_patch.py:341: UserWarning: /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle2onnx/op_mapper/custom_paddle_op/deformable_conv.py:220
    The behavior of expression A * B has been unified with elementwise_mul(X, Y, axis=-1) from Paddle 2.0. If your code works well in the older versions but crashes in this version, try to use elementwise_mul(X, Y, axis=0) instead of A * B. This transitional warning will be dropped in the future.
      op_type, op_type, EXPRESSION_MAP[method_name]))
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle/fluid/layers/math_op_patch.py:341: UserWarning: /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle2onnx/op_mapper/custom_paddle_op/deformable_conv.py:222
    The behavior of expression A - B has been unified with elementwise_sub(X, Y, axis=-1) from Paddle 2.0. If your code works well in the older versions but crashes in this version, try to use elementwise_sub(X, Y, axis=0) instead of A - B. This transitional warning will be dropped in the future.
      op_type, op_type, EXPRESSION_MAP[method_name]))
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle/fluid/layers/math_op_patch.py:341: UserWarning: /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle2onnx/op_mapper/custom_paddle_op/deformable_conv.py:225
    The behavior of expression A - B has been unified with elementwise_sub(X, Y, axis=-1) from Paddle 2.0. If your code works well in the older versions but crashes in this version, try to use elementwise_sub(X, Y, axis=0) instead of A - B. This transitional warning will be dropped in the future.
      op_type, op_type, EXPRESSION_MAP[method_name]))
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle/fluid/layers/math_op_patch.py:341: UserWarning: /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle2onnx/op_mapper/custom_paddle_op/deformable_conv.py:225
    The behavior of expression A * B has been unified with elementwise_mul(X, Y, axis=-1) from Paddle 2.0. If your code works well in the older versions but crashes in this version, try to use elementwise_mul(X, Y, axis=0) instead of A * B. This transitional warning will be dropped in the future.
      op_type, op_type, EXPRESSION_MAP[method_name]))
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle/fluid/layers/math_op_patch.py:341: UserWarning: /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle2onnx/op_mapper/custom_paddle_op/deformable_conv.py:227
    The behavior of expression A - B has been unified with elementwise_sub(X, Y, axis=-1) from Paddle 2.0. If your code works well in the older versions but crashes in this version, try to use elementwise_sub(X, Y, axis=0) instead of A - B. This transitional warning will be dropped in the future.
      op_type, op_type, EXPRESSION_MAP[method_name]))
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle/fluid/layers/math_op_patch.py:341: UserWarning: /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle2onnx/op_mapper/custom_paddle_op/deformable_conv.py:230
    The behavior of expression A - B has been unified with elementwise_sub(X, Y, axis=-1) from Paddle 2.0. If your code works well in the older versions but crashes in this version, try to use elementwise_sub(X, Y, axis=0) instead of A - B. This transitional warning will be dropped in the future.
      op_type, op_type, EXPRESSION_MAP[method_name]))
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle/fluid/layers/math_op_patch.py:341: UserWarning: /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle2onnx/op_mapper/custom_paddle_op/deformable_conv.py:230
    The behavior of expression A * B has been unified with elementwise_mul(X, Y, axis=-1) from Paddle 2.0. If your code works well in the older versions but crashes in this version, try to use elementwise_mul(X, Y, axis=0) instead of A * B. This transitional warning will be dropped in the future.
      op_type, op_type, EXPRESSION_MAP[method_name]))
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle/fluid/layers/math_op_patch.py:341: UserWarning: /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle2onnx/op_mapper/custom_paddle_op/deformable_conv.py:239
    The behavior of expression A + B has been unified with elementwise_add(X, Y, axis=-1) from Paddle 2.0. If your code works well in the older versions but crashes in this version, try to use elementwise_add(X, Y, axis=0) instead of A + B. This transitional warning will be dropped in the future.
      op_type, op_type, EXPRESSION_MAP[method_name]))
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle/fluid/layers/math_op_patch.py:341: UserWarning: /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle2onnx/op_mapper/custom_paddle_op/deformable_conv.py:260
    The behavior of expression A + B has been unified with elementwise_add(X, Y, axis=-1) from Paddle 2.0. If your code works well in the older versions but crashes in this version, try to use elementwise_add(X, Y, axis=0) instead of A + B. This transitional warning will be dropped in the future.
      op_type, op_type, EXPRESSION_MAP[method_name]))
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle/fluid/layers/math_op_patch.py:341: UserWarning: /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle2onnx/op_mapper/custom_paddle_op/deformable_conv.py:119
    The behavior of expression A * B has been unified with elementwise_mul(X, Y, axis=-1) from Paddle 2.0. If your code works well in the older versions but crashes in this version, try to use elementwise_mul(X, Y, axis=0) instead of A * B. This transitional warning will be dropped in the future.
      op_type, op_type, EXPRESSION_MAP[method_name]))
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle/fluid/layers/math_op_patch.py:341: UserWarning: /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle2onnx/op_mapper/custom_paddle_op/deformable_conv.py:119
    The behavior of expression A + B has been unified with elementwise_add(X, Y, axis=-1) from Paddle 2.0. If your code works well in the older versions but crashes in this version, try to use elementwise_add(X, Y, axis=0) instead of A + B. This transitional warning will be dropped in the future.
      op_type, op_type, EXPRESSION_MAP[method_name]))
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle/fluid/layers/math_op_patch.py:341: UserWarning: /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle2onnx/op_mapper/custom_paddle_op/deformable_conv.py:120
    The behavior of expression A * B has been unified with elementwise_mul(X, Y, axis=-1) from Paddle 2.0. If your code works well in the older versions but crashes in this version, try to use elementwise_mul(X, Y, axis=0) instead of A * B. This transitional warning will be dropped in the future.
      op_type, op_type, EXPRESSION_MAP[method_name]))
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle/fluid/layers/math_op_patch.py:341: UserWarning: /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle2onnx/op_mapper/custom_paddle_op/deformable_conv.py:120
    The behavior of expression A + B has been unified with elementwise_add(X, Y, axis=-1) from Paddle 2.0. If your code works well in the older versions but crashes in this version, try to use elementwise_add(X, Y, axis=0) instead of A + B. This transitional warning will be dropped in the future.
      op_type, op_type, EXPRESSION_MAP[method_name]))
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle/fluid/layers/math_op_patch.py:341: UserWarning: /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/paddle2onnx/op_mapper/custom_paddle_op/deformable_conv.py:127
    The behavior of expression A * B has been unified with elementwise_mul(X, Y, axis=-1) from Paddle 2.0. If your code works well in the older versions but crashes in this version, try to use elementwise_mul(X, Y, axis=0) instead of A * B. This transitional warning will be dropped in the future.
      op_type, op_type, EXPRESSION_MAP[method_name]))
    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/onnx/helper.py:343: DeprecationWarning: Using or importing the ABCs from 'collections' instead of from 'collections.abc' is deprecated, and in 3.8 it will stop working
      is_iterable = isinstance(value, collections.Iterable)
    [1;31;40m2022-02-24 18:21:40 [WARNING]	Due to the operator:matrix_nms, the converted ONNX model will only supports input[batch_size] == 1.[0m
    [1;31;40m2022-02-24 18:21:40 [WARNING]	Operator:matrix_nms is not supported completely, so we use traditional NMS (nms_theshold=0.5) to instead it, which introduce some difference.[0m
    2022-02-24 18:21:43 [INFO]	ONNX model generated is valid.
    2022-02-24 18:21:44 [INFO]	ONNX model saved in /home/aistudio/ppyolov2_voc.onnx


**å¯ä»¥çœ‹åˆ°ï¼Œæ¨¡å‹æˆåŠŸè½¬åŒ–ä¸ºonnxæ ¼å¼**

![](https://ai-studio-static-online.cdn.bcebos.com/5ea4fb5230ef414886a10b72b177b5ef336bd24db33949fdbdfaec1d7c4e0f0e)


## ï¼ˆ5ï¼‰onnxæ¨¡å‹æµ‹è¯•


```python
import os
import onnxruntime

def load_onnx(model_dir):
    model_path = os.path.join(model_dir, 'ppyolov2_voc.onnx')
    session = onnxruntime.InferenceSession(model_path)

    input_names = [input.name for input in session.get_inputs()]
    output_names = [output.name for output in session.get_outputs()]

    return session, input_names, output_names

session, input_names, output_names = load_onnx("/home/aistudio")

print(input_names, output_names)
```

    ['im_shape', 'image', 'scale_factor'] ['matrix_nms_0.tmp_0', 'matrix_nms_0.tmp_2']


    2022-02-24 18:23:04.017113905 [W:onnxruntime:, graph.cc:3526 CleanUnusedInitializersAndNodeArgs] Removing initializer 'Constant_1188'. It is not used by any node and should be removed from the model.


# ä¹ã€æ€»ç»“

åˆ°æ­¤æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨PP-YOLOV2å®Œæˆäº†æ˜¯å¦ä½©æˆ´å£ç½©çš„ç›®æ ‡è¯†åˆ«æ£€æµ‹ï¼Œå¹¶ä¸”mAPå·²ç»è¾¾åˆ°äº†84.34%ã€‚

è€Œä¸”æ¨¡å‹å·²ç»è½¬åŒ–ä¸ºonnxï¼Œä¾¿äºéƒ¨ç½²åˆ°ä¸åŒçš„ç¡¬ä»¶å¹³å°ä¸Š

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**

> å¯ä»¥é€šè¿‡å¢åŠ æ•°æ®é›†ã€é€‰æ‹©æ›´ä¼˜åŒ–æ¨¡å‹ï¼Œå¢åŠ è®­ç»ƒçš„æ¬¡æ•°ã€‚

**åæœŸåº”ç”¨ï¼š**

> åæœŸå¯ä»¥éƒ¨ç½²åˆ°å•†åœºã€åŒ»é™¢ã€ç–—å…»é™¢ç­‰å…¬å…±åœºåˆçš„è¿›å‡ºå£ï¼Œé…åˆå·¥ä½œäººå‘˜è¿›è¡Œå®‰å…¨ç®¡æ§ã€‚

# ä½œè€…ç®€ä»‹

> - [ä¸ªäººä¸»é¡µ](https://aistudio.baidu.com/aistudio/personalcenter/thirdview/1966674)

> - æ„Ÿå…´è¶£çš„æ–¹å‘ï¼šCV

> - æ¬¢è¿å¤§å®¶æœ‰é—®é¢˜ç•™è¨€äº¤æµå­¦ä¹ ï¼Œå…±åŒè¿›æ­¥æˆé•¿ã€‚
